#import Test from "../test"
#import Fs from "../fs"
#import Kv from "../kv"
#import Lib from "../lib"
#import XCrypto from "../xcrypto"

Test.test "XCrypto.getFromCache returns cached password", function ()
	originalRead = @Kv.read

	Kv.read = function ()
		return [
			["hash1", "pass1"],
			["hash2", "pass2"]
		]
	end function

	result = XCrypto.getFromCache("hash2")

	Test.expect(result).toBe("pass2")

	Kv.read = @originalRead
end function

Test.test "XCrypto.getFromCache returns null for missing hash", function ()
	originalRead = @Kv.read

	Kv.read = function ()
		return [
			["hash1", "pass1"]
		]
	end function

	result = XCrypto.getFromCache("nonexistent")

	Test.expect(result).toBe(null)

	Kv.read = @originalRead
end function

Test.test "XCrypto._addToCache stores entry correctly", function ()
	originalWrite = @Kv.setKv
	originalRead = @Kv.read

	Kv.read = function ()
		return []
	end function

	state = {"cached": null}
	Kv.setKv = function (entry)
		state.cached = entry
	end function

	XCrypto._addToCache("testhash", "testpass")

	Test.expect(state.cached[0]).toBe("testhash")
	Test.expect(state.cached[1]).toBe("testpass")

	Kv.setKv = @originalWrite
	Kv.read = @originalRead
end function

Test.test "XCrypto.getFromCache handles empty cache", function ()
	originalRead = @Kv.read

	Kv.read = function ()
		return []
	end function

	result = XCrypto.getFromCache("anyhash")

	Test.expect(result).toBe(null)

	Kv.read = @originalRead
end function

Test.test "XCrypto.decipher extracts hash from user:hash format", function ()
	originalRead = @Kv.read
	originalGetFromCache = @XCrypto.getFromCache

	state = {"hashChecked": null}
	Kv.read = function ()
		return []
	end function

	XCrypto.getFromCache = function (hash)
		state.hashChecked = hash
		return null
	end function

	result = XCrypto.decipher("alice:myhash456")

	Test.expect(state.hashChecked).toBe("myhash456")

	Kv.read = @originalRead
	XCrypto.getFromCache = @originalGetFromCache
end function

Test.runTests()
